version: '3'

services:
  facade:
    build: ./facade-service
    ports:
    - "8000:8000"
    container_name: facade
    depends_on:
    - messages-node1
    - messages-node2
    - logging-node1
    - logging-node2
    - logging-node3
    networks:
    - micro-mq

  logging-node1:
    build: ./logging-service
    container_name: logging-node1
    ports:
    - "8001:8000"
    depends_on:
    - hazelcast-node1
    networks:
    - micro-mq
  
  logging-node2:
    build: ./logging-service
    container_name: logging-node2
    ports:
    - "8002:8000"
    depends_on:
    - hazelcast-node2
    networks:
    - micro-mq
  
  logging-node3:
    build: ./logging-service
    container_name: logging-node3
    ports:
    - "8003:8000"
    depends_on:
    - hazelcast-node3
    networks:
    - micro-mq

  messages-node1:
    build: ./messages-service
    container_name: messages-node1
    ports:
    - "8004:8000"
    depends_on:
    - kafka
    networks:
    - micro-mq
  
  messages-node2:
    build: ./messages-service
    container_name: messages-node2
    ports:
    - "8005:8000"
    depends_on:
    - kafka
    networks:
    - micro-mq

  hazelcast-node1:
    image: hazelcast/hazelcast:latest
    container_name: hazelcast-node1
    ports:
    - "127.0.0.1:5701:5701"
    networks:
    - micro-mq
    environment:
    - HZ_CLUSTERNAME=micro-hazelcast

  hazelcast-node2:
    image: hazelcast/hazelcast:latest
    container_name: hazelcast-node2
    ports:
    - "127.0.0.1:5702:5701"
    networks:
    - micro-mq
    environment:
    - HZ_CLUSTERNAME=micro-hazelcast
    
  hazelcast-node3:
    image: hazelcast/hazelcast:latest
    container_name: hazelcast-node3
    ports:
    - "127.0.0.1:5703:5701"
    networks:
    - micro-mq
    environment:
    - HZ_CLUSTERNAME=micro-hazelcast

  management-center:
    image: hazelcast/management-center:latest
    container_name: management-center
    ports:
    - "8080:8080"
    environment:
    - MC_DEFAULT_CLUSTER=dev
    - MC_DEFAULT_CLUSTER_MEMBERS=hazelcast-node1, hazelcast-node2, hazelcast-node3
    - HZ_CLUSTERNAME=micro-hazelcast
    networks:
    - micro-mq

  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: zookeeper-server
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ALLOW_ANONYMOUS_LOGIN: yes
    ports:
      - 2181:2181
    networks:
      - micro-mq
  
  kafka:
    image: bitnami/kafka:latest
    container_name: kafka-server
    depends_on:
      - zookeeper
    ports:
      - 9092:9092
    environment:
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      ALLOW_PLAINTEXT_LISTENER: yes
    networks:
      - micro-mq
  
  kafka-setup:
    image: bitnami/kafka:latest
    container_name: kafka-setup
    restart: "no"
    depends_on:
      - kafka
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      # blocks until kafka is reachable
      kafka-topics --bootstrap-server kafka-server:9092 --list

      kafka-topics --bootstrap-server kafka-server:9092 --create --if-not-exists --topic messages --replication-factor 1
      "
    networks:
      - micro-mq

networks:
  micro-mq:
    name: micro-mq